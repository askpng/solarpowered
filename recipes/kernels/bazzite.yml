modules:
  - type: copy
    from: ghcr.io/ublue-os/akmods:bazzite-42
    src: /
    dest: /tmp/akmods

  - type: copy
    from: ghcr.io/ublue-os/akmods-extra:bazzite-42
    src: /rpms/kmods
    dest: /tmp/akmods-extra/rpms/kmods

  - type: script
    snippets:
      # Remove default kernel & remove leftover modules
      - dnf -y remove kernel-* && rm -drf /usr/lib/modules/*
      # Add ublue-os COPR repo
      - curl -L https://copr.fedorainfracloud.org/coprs/ublue-os/akmods/repo/fedora-$(rpm -E %fedora)/ublue-os-akmods-fedora-$(rpm -E %fedora).repo -o /etc/yum.repos.d/_copr_ublue-os-akmods.repo
      # Terra repo
      - curl -L "https://raw.githubusercontent.com/terrapkg/subatomic-repos/main/terra.repo" -o /etc/yum.repos.d/terra.repo
      # Install Bazzite kernel, as we need it for kmods compatibility
      # Also install v4l2loopback, ryzen_smu, zenergy kmods and scx-scheds
      - dnf -y install --setopt=install_weak_deps=False
          /tmp/akmods/kernel-rpms/kernel-*.rpm
          /tmp/akmods/rpms/kmods/*-v4l2loopback-*.rpm
          /tmp/akmods-extra/rpms/kmods/*ryzen-smu*.rpm
          /tmp/akmods-extra/rpms/kmods/*zenergy*.rpm
          scx-scheds
      # Remove ublue-os COPR repo, kernel-cachyos-addons COPR repo, and terra repo
      - rm /etc/yum.repos.d/_copr_ublue-os-akmods.repo
          /etc/yum.repos.d/terra.repo
      # Cleanup 
      - dnf clean all

  - type: systemd
    system:
      enabled:
      - scx_loader.service
