modules:
  - type: script
    snippets:
      - dnf -y install --setopt=install_weak_deps=False
          dnf-plugins-core
          dnf5-plugins
      - dnf -y remove kernel* && rm -r -f /usr/lib/modules/*
      - dnf -y config-manager setopt "*fedora*".exclude="
          kernel
          kernel-core
          kernel-modules
          kernel-modules-core
          kernel-modules-extra
          kernel-devel
          kernel-headers
          " 
      - dnf -y copr enable sentry/kernel-blu
      - dnf -y copr enable ublue-os/akmods
      - curl -L "https://raw.githubusercontent.com/terrapkg/subatomic-repos/main/terra.repo" -o /etc/yum.repos.d/terra.repo    
      - dnf -y install --setopt=install_weak_deps=False
          akmods
          kernel
          kernel-devel
          kernel-modules-extra
          zenergy
          v4l2loopback
    # Needed if we use --setopt=tsflags=noscripts
    #   - dnf -y install --setopt=install_weak_deps=False
    #       zenergy*.fc$(rpm -E %fedora).$(rpm -E '%_arch')
    #       v4l2loopback
    #   - VER=$(ls /lib/modules) &&
    #       akmods --force --kernels $VER --kmod v4l2loopback &&
    #       akmods --force --kernels $VER --kmod zenergy && 
    #       depmod -a $VER &&
    #       dracut -v --kver $VER --force --add ostree --no-hostonly --reproducible /usr/lib/modules/$VER/initramfs.img
      - rm -f /etc/yum.repos.d/{*copr*,*terra*}